<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AMETHYST — Alchemist Calendar</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Cinzel:wght@400;600;700;900&family=Cormorant+SC:wght@600;700&family=Orbitron:wght@400;700;900&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #04060f;
    --bg2: #080c1c;
    --bg3: #0c1224;
    --accent1: #a78bfa;
    --accent2: #f472b6;
    --accent3: #818cf8;
    --accent4: #fbbf24;
    --accent5: #6ee7b7;
    --gold: #e5c46b;
    --silver: #c8d4e8;
    --mint: #7ee8c8;
    --text: #e8eaf6;
    --text-dim: #6b7da0;
    --border: rgba(167,139,250,0.18);
    --glow1: 0 0 24px rgba(167,139,250,0.5);
    --glow2: 0 0 24px rgba(244,114,182,0.45);
    --glow3: 0 0 28px rgba(99,102,241,0.5);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans SC', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ── PURPLE NEBULA AMBIENT LIGHT ── */
  body::after {
    content:'';
    position:fixed; inset:0;
    background:
      radial-gradient(ellipse 70% 50% at 15% 20%, rgba(109,40,217,0.18) 0%, transparent 65%),
      radial-gradient(ellipse 55% 45% at 85% 75%, rgba(79,70,229,0.16) 0%, transparent 65%),
      radial-gradient(ellipse 60% 40% at 50% 0%,  rgba(139,92,246,0.14) 0%, transparent 60%),
      radial-gradient(ellipse 40% 55% at 95% 30%, rgba(167,139,250,0.1) 0%, transparent 60%),
      radial-gradient(ellipse 50% 35% at 5% 80%,  rgba(99,102,241,0.12) 0%, transparent 60%),
      radial-gradient(ellipse 80% 30% at 50% 100%, rgba(76,29,149,0.22) 0%, transparent 60%);
    pointer-events:none; z-index:0;
    animation: nebulaPulse 12s ease-in-out infinite alternate;
  }
  @keyframes nebulaPulse {
    0%   { opacity:0.7; transform:scale(1); }
    50%  { opacity:1;   transform:scale(1.03); }
    100% { opacity:0.8; transform:scale(0.98); }
  }

  /* Stars */
  body::before {
    content:'';
    position:fixed; inset:0;
    background-image:
      radial-gradient(1px 1px at 7% 11%, rgba(255,255,255,0.8) 0%, transparent 100%),
      radial-gradient(1px 1px at 18% 42%, rgba(255,255,255,0.6) 0%, transparent 100%),
      radial-gradient(1px 1px at 26% 70%, rgba(255,255,255,0.7) 0%, transparent 100%),
      radial-gradient(1px 1px at 35% 22%, rgba(255,255,255,0.5) 0%, transparent 100%),
      radial-gradient(1px 1px at 42% 85%, rgba(255,255,255,0.6) 0%, transparent 100%),
      radial-gradient(1px 1px at 50% 55%, rgba(255,255,255,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 57% 17%, rgba(255,255,255,0.7) 0%, transparent 100%),
      radial-gradient(1px 1px at 63% 75%, rgba(255,255,255,0.5) 0%, transparent 100%),
      radial-gradient(1px 1px at 70% 38%, rgba(255,255,255,0.6) 0%, transparent 100%),
      radial-gradient(1px 1px at 78% 92%, rgba(255,255,255,0.4) 0%, transparent 100%),
      radial-gradient(1px 1px at 85% 28%, rgba(255,255,255,0.7) 0%, transparent 100%),
      radial-gradient(1px 1px at 91% 62%, rgba(255,255,255,0.5) 0%, transparent 100%),
      radial-gradient(1.5px 1.5px at 14% 58%, rgba(255,255,255,0.9) 0%, transparent 100%),
      radial-gradient(1.5px 1.5px at 47% 30%, rgba(255,255,255,0.8) 0%, transparent 100%),
      radial-gradient(1.5px 1.5px at 73% 50%, rgba(255,255,255,0.7) 0%, transparent 100%),
      radial-gradient(2px 2px at 3% 88%, rgba(0,245,255,0.6) 0%, transparent 100%),
      radial-gradient(2px 2px at 96% 14%, rgba(123,47,255,0.6) 0%, transparent 100%),
      radial-gradient(2px 2px at 55% 4%, rgba(255,184,0,0.5) 0%, transparent 100%);
    pointer-events:none; z-index:0;
    animation: twinkle 16s ease-in-out infinite alternate;
  }
  @keyframes twinkle {
    0%   { opacity:0.7; }
    100% { opacity:1; }
  }

  /* ══════════════════════════════
     PLANET STAGE
  ══════════════════════════════ */
  #planet-stage {
    position:fixed; inset:0;
    pointer-events:none; z-index:0; overflow:hidden;
  }

  .planet-wrap {
    position:absolute;
    top:3%; right:3%;
    display:none;
    animation: floatPlanet 20s ease-in-out infinite alternate;
  }
  .planet-wrap.visible { display:block; will-change:transform; }

  @keyframes floatPlanet {
    0%   { transform:translateY(0px) rotate(0deg); }
    50%  { transform:translateY(-20px) rotate(2deg); }
    100% { transform:translateY(8px) rotate(-1.5deg); }
  }

  .planet-label {
    font-family:'Orbitron', monospace;
    font-size:9px; letter-spacing:3px;
    color:rgba(255,255,255,0.3);
    text-align:center;
    margin-top:10px;
    white-space:nowrap;
  }

  /* ── EARTH ── */
  .planet-earth {
    width:200px; height:200px; border-radius:50%;
    background: radial-gradient(circle at 38% 34%,
      #b8f0d4 0%, #4fc3f7 22%, #1976d2 50%, #0d47a1 72%, #041530 92%, #010408 100%);
    box-shadow:
      inset -30px -20px 45px rgba(0,0,0,0.6),
      inset 12px 10px 30px rgba(255,255,255,0.12),
      0 0 70px rgba(79,195,247,0.4), 0 0 140px rgba(25,118,210,0.2);
    position:relative;
  }
  .planet-earth::before {
    content:''; position:absolute; inset:0; border-radius:50%;
    background:
      radial-gradient(ellipse 55% 18% at 58% 28%, rgba(255,255,255,0.3) 0%, transparent 60%),
      radial-gradient(ellipse 40% 14% at 32% 62%, rgba(184,240,212,0.35) 0%, transparent 60%),
      radial-gradient(ellipse 65% 12% at 70% 68%, rgba(255,255,255,0.1) 0%, transparent 60%);
  }
  .planet-earth::after {
    content:''; position:absolute; inset:0; border-radius:50%;
    background: radial-gradient(ellipse at 28% 20%, rgba(255,255,255,0.22) 0%, transparent 45%);
  }

  /* ── MARS ── */
  .planet-mars {
    width:155px; height:155px; border-radius:50%;
    background: radial-gradient(circle at 40% 37%,
      #eea080 0%, #c0392b 28%, #922b21 58%, #5a1a0d 82%, #160400 97%, #000 100%);
    box-shadow:
      inset -22px -14px 35px rgba(0,0,0,0.62),
      inset 8px 6px 20px rgba(255,180,140,0.14),
      0 0 55px rgba(192,57,43,0.45), 0 0 110px rgba(146,43,33,0.22);
    position:relative;
  }
  .planet-mars::before {
    content:''; position:absolute; inset:0; border-radius:50%;
    background:
      radial-gradient(ellipse 32% 14% at 44% 38%, rgba(255,210,190,0.22) 0%, transparent 60%),
      radial-gradient(circle 13px at 36% 54%, rgba(80,20,10,0.55) 0%, transparent 60%),
      radial-gradient(circle 9px at 61% 43%, rgba(60,15,5,0.45) 0%, transparent 60%),
      radial-gradient(circle 7px at 52% 66%, rgba(100,30,5,0.4) 0%, transparent 55%);
  }

  /* ── JUPITER ── */
  .planet-jupiter {
    width:240px; height:240px; border-radius:50%;
    background: radial-gradient(circle at 40% 40%,
      #f5cba7 0%, #e59866 14%, #ca6f1e 27%,
      #d4ac7a 38%, #a04000 50%, #e8d5b0 62%,
      #ca6f1e 74%, #784212 88%, #2c1503 100%);
    box-shadow:
      inset -38px -24px 55px rgba(0,0,0,0.52),
      inset 14px 10px 38px rgba(255,220,180,0.1),
      0 0 75px rgba(229,152,102,0.35), 0 0 150px rgba(202,111,30,0.18);
    overflow:hidden; position:relative;
  }
  .planet-jupiter::before {
    content:''; position:absolute; inset:0; border-radius:50%;
    background: repeating-linear-gradient(
      0deg,
      transparent 0px, transparent 10px,
      rgba(160,64,0,0.3) 10px, rgba(160,64,0,0.3) 18px,
      transparent 18px, transparent 28px,
      rgba(245,203,167,0.2) 28px, rgba(245,203,167,0.2) 36px
    );
    mix-blend-mode:overlay;
  }
  .planet-jupiter::after {
    content:''; position:absolute;
    width:38px; height:24px;
    background:radial-gradient(ellipse, rgba(200,100,60,0.65) 0%, transparent 70%);
    top:50%; left:28%; transform:translateY(-50%);
    border-radius:50%;
  }

  /* ── SATURN ── */
  .saturn-wrap { position:relative; width:320px; height:250px; }
  .saturn-globe {
    width:180px; height:180px; border-radius:50%;
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    background: radial-gradient(circle at 38% 36%,
      #f9e4b7 0%, #e8c87a 20%, #c9a227 44%, #9b7a0e 65%, #4a3600 85%, #190f00 100%);
    box-shadow:
      inset -26px -17px 42px rgba(0,0,0,0.56),
      inset 10px 8px 26px rgba(255,240,180,0.12),
      0 0 60px rgba(201,162,39,0.38), 0 0 120px rgba(155,122,14,0.2);
    z-index:2; overflow:hidden;
  }
  .saturn-globe::before {
    content:''; position:absolute; inset:0; border-radius:50%;
    background: repeating-linear-gradient(
      0deg,
      transparent 0px, transparent 9px,
      rgba(180,130,0,0.22) 9px, rgba(180,130,0,0.22) 16px,
      transparent 16px, transparent 23px,
      rgba(255,215,80,0.12) 23px, rgba(255,215,80,0.12) 30px
    );
    mix-blend-mode:overlay;
  }
  .saturn-ring {
    position:absolute; top:50%; left:50%;
    width:310px; height:90px;
    border-radius:50%;
    border-width:18px; border-style:solid;
    border-color:rgba(210,175,65,0.55) transparent rgba(175,130,28,0.35) transparent;
    transform:translate(-50%,-50%) rotateX(70deg);
    z-index:1;
    box-shadow:0 0 25px rgba(210,175,65,0.3);
  }
  .saturn-ring2 {
    position:absolute; top:50%; left:50%;
    width:360px; height:108px;
    border-radius:50%;
    border-width:10px; border-style:solid;
    border-color:rgba(200,155,45,0.28) transparent rgba(155,110,20,0.2) transparent;
    transform:translate(-50%,-50%) rotateX(70deg);
    z-index:0;
  }

  /* ── NEPTUNE ── */
  .planet-neptune {
    width:170px; height:170px; border-radius:50%;
    background: radial-gradient(circle at 36% 34%,
      #a8d8f0 0%, #4a90d9 20%, #1a5fa8 42%, #0d3d7a 65%, #051e42 85%, #010610 100%);
    box-shadow:
      inset -24px -15px 38px rgba(0,0,0,0.6),
      inset 9px 7px 22px rgba(168,216,240,0.15),
      0 0 60px rgba(74,144,217,0.48), 0 0 120px rgba(26,95,168,0.26);
    position:relative;
  }
  .planet-neptune::before {
    content:''; position:absolute; inset:0; border-radius:50%;
    background:
      radial-gradient(ellipse 70% 14% at 50% 35%, rgba(255,255,255,0.2) 0%, transparent 60%),
      radial-gradient(ellipse 50% 10% at 50% 60%, rgba(100,180,240,0.22) 0%, transparent 60%),
      radial-gradient(circle 22px at 55% 45%, rgba(255,255,255,0.18) 0%, transparent 55%);
  }

  /* ── LAVA ── */
  .planet-lava {
    width:190px; height:190px; border-radius:50%;
    background: radial-gradient(circle at 40% 38%,
      #ffaa55 0%, #e63900 18%, #9b2600 44%, #6b0f00 68%, #200400 88%, #040000 100%);
    box-shadow:
      inset -28px -18px 42px rgba(0,0,0,0.55),
      inset 10px 8px 28px rgba(255,120,40,0.18),
      0 0 80px rgba(230,57,0,0.55), 0 0 160px rgba(155,38,0,0.3);
    position:relative;
    animation: floatPlanet 20s ease-in-out infinite alternate, lavaGlow 3s ease-in-out infinite alternate;
  }
  @keyframes lavaGlow {
    0%   { box-shadow: inset -28px -18px 42px rgba(0,0,0,0.55),inset 10px 8px 28px rgba(255,120,40,0.18),0 0 80px rgba(230,57,0,0.55),0 0 160px rgba(155,38,0,0.3); }
    100% { box-shadow: inset -28px -18px 42px rgba(0,0,0,0.55),inset 10px 8px 28px rgba(255,120,40,0.18),0 0 120px rgba(255,80,0,0.75),0 0 240px rgba(200,50,0,0.45); }
  }
  .planet-lava::before {
    content:''; position:absolute; inset:0; border-radius:50%;
    background:
      radial-gradient(ellipse 40% 20% at 50% 40%, rgba(255,200,80,0.28) 0%, transparent 60%),
      radial-gradient(circle 16px at 35% 55%, rgba(255,160,60,0.45) 0%, transparent 50%),
      radial-gradient(circle 11px at 65% 50%, rgba(255,100,20,0.35) 0%, transparent 50%),
      radial-gradient(circle 9px at 50% 70%, rgba(200,60,0,0.5) 0%, transparent 50%);
  }

  /* ── FOREST ── */
  .planet-forest {
    width:210px; height:210px; border-radius:50%;
    background: radial-gradient(circle at 38% 35%,
      #b8f07a 0%, #56ab2f 22%, #1a7a1a 44%, #0d4a0d 68%, #021002 88%, #000 100%);
    box-shadow:
      inset -30px -18px 45px rgba(0,0,0,0.55),
      inset 10px 8px 28px rgba(168,224,99,0.12),
      0 0 65px rgba(86,171,47,0.38), 0 0 130px rgba(26,122,26,0.2);
    position:relative;
  }
  .planet-forest::before {
    content:''; position:absolute; inset:0; border-radius:50%;
    background:
      radial-gradient(ellipse 50% 18% at 44% 30%, rgba(200,240,100,0.2) 0%, transparent 60%),
      radial-gradient(ellipse 35% 12% at 60% 65%, rgba(100,180,50,0.22) 0%, transparent 60%),
      radial-gradient(circle 26px at 30% 50%, rgba(0,80,0,0.4) 0%, transparent 50%),
      radial-gradient(circle 18px at 65% 40%, rgba(40,120,10,0.38) 0%, transparent 50%);
  }

  /* ── DESERT ── */
  .planet-desert {
    width:175px; height:175px; border-radius:50%;
    background: radial-gradient(circle at 40% 37%,
      #fdeaa8 0%, #f0c040 22%, #c8960c 48%, #8b6400 70%, #3d2800 88%, #090400 100%);
    box-shadow:
      inset -25px -16px 38px rgba(0,0,0,0.52),
      inset 9px 7px 22px rgba(253,234,168,0.12),
      0 0 58px rgba(240,192,64,0.38), 0 0 115px rgba(200,150,12,0.2);
    position:relative;
  }
  .planet-desert::before {
    content:''; position:absolute; inset:0; border-radius:50%;
    background:
      radial-gradient(ellipse 62% 14% at 50% 28%, rgba(255,245,200,0.22) 0%, transparent 60%),
      radial-gradient(circle 20px at 38% 58%, rgba(160,100,0,0.42) 0%, transparent 50%),
      radial-gradient(circle 14px at 62% 48%, rgba(180,120,10,0.38) 0%, transparent 50%),
      radial-gradient(circle 10px at 55% 70%, rgba(120,70,0,0.35) 0%, transparent 50%);
  }

  /* ── CRYSTAL ICE ── */
  .planet-crystal {
    width:185px; height:185px; border-radius:50%;
    background: radial-gradient(circle at 36% 32%,
      #eef8ff 0%, #b3e5fc 18%, #4dd0e1 38%, #0097a7 60%, #005662 82%, #000d10 100%);
    box-shadow:
      inset -26px -17px 40px rgba(0,0,0,0.44),
      inset 14px 12px 32px rgba(255,255,255,0.28),
      0 0 65px rgba(77,208,225,0.5), 0 0 130px rgba(0,151,167,0.28);
    position:relative;
  }
  .planet-crystal::before {
    content:''; position:absolute; inset:0; border-radius:50%;
    background:
      radial-gradient(ellipse 68% 26% at 40% 27%, rgba(255,255,255,0.4) 0%, transparent 55%),
      radial-gradient(ellipse 32% 12% at 65% 62%, rgba(200,240,255,0.22) 0%, transparent 55%),
      radial-gradient(circle 20px at 55% 46%, rgba(255,255,255,0.32) 0%, transparent 50%);
  }

  /* ── PURPLE STORM ── */
  .planet-storm {
    width:220px; height:220px; border-radius:50%;
    background: radial-gradient(circle at 40% 38%,
      #d7a8f5 0%, #9b59b6 20%, #6c3483 44%, #4a235a 65%, #1e0828 85%, #040008 100%);
    box-shadow:
      inset -32px -20px 48px rgba(0,0,0,0.55),
      inset 12px 9px 32px rgba(215,168,245,0.12),
      0 0 80px rgba(155,89,182,0.55), 0 0 160px rgba(108,52,131,0.3);
    overflow:hidden; position:relative;
    animation: floatPlanet 20s ease-in-out infinite alternate, stormPulse 5s ease-in-out infinite alternate;
  }
  @keyframes stormPulse {
    0%   { opacity: 0.9; }
    100% { opacity: 1; }
  }
  .planet-storm::before {
    content:''; position:absolute; inset:0; border-radius:50%;
    background: repeating-linear-gradient(
      15deg,
      transparent 0px, transparent 13px,
      rgba(185,80,225,0.2) 13px, rgba(185,80,225,0.2) 21px,
      transparent 21px, transparent 32px,
      rgba(120,40,165,0.15) 32px, rgba(120,40,165,0.15) 40px
    );
    mix-blend-mode:overlay;
  }
  .planet-storm::after {
    content:''; position:absolute;
    width:46px; height:28px;
    background:radial-gradient(ellipse, rgba(220,150,255,0.6) 0%, transparent 70%);
    top:42%; left:27%; border-radius:50%;
  }

  /* ── EXOTIC with moon ── */
  .exotic-wrap { position:relative; width:260px; height:260px; }
  .planet-exotic {
    width:195px; height:195px; border-radius:50%;
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    background: radial-gradient(circle at 38% 36%,
      #f8e1b5 0%, #e8a838 20%, #b06820 44%, #753210 68%, #2e0f00 88%, #050100 100%);
    box-shadow:
      inset -28px -18px 42px rgba(0,0,0,0.55),
      inset 10px 8px 28px rgba(248,225,181,0.12),
      0 0 62px rgba(232,168,56,0.42), 0 0 124px rgba(176,104,32,0.22);
    z-index:2; overflow:hidden;
  }
  .planet-exotic::before {
    content:''; position:absolute; inset:0; border-radius:50%;
    background:
      radial-gradient(ellipse 55% 16% at 50% 32%, rgba(255,240,180,0.22) 0%, transparent 55%),
      radial-gradient(circle 22px at 40% 55%, rgba(120,50,10,0.45) 0%, transparent 50%),
      radial-gradient(circle 16px at 62% 44%, rgba(100,40,8,0.42) 0%, transparent 50%);
  }
  .moon-small {
    width:42px; height:42px; border-radius:50%;
    position:absolute; top:10px; right:14px; z-index:3;
    background: radial-gradient(circle at 35% 34%, #e0cfa0 0%, #b8a060 40%, #6a5420 75%, #1a1000 100%);
    box-shadow: inset -6px -4px 12px rgba(0,0,0,0.52), 0 0 14px rgba(200,160,60,0.32);
  }

  /* ── SNOW ── */
  .planet-snow {
    width:180px; height:180px; border-radius:50%;
    background: radial-gradient(circle at 35% 32%,
      #ffffff 0%, #d6eaf8 14%, #85c1e9 34%, #2e86c1 58%, #1a5276 80%, #030c18 100%);
    box-shadow:
      inset -26px -16px 40px rgba(0,0,0,0.4),
      inset 16px 13px 35px rgba(255,255,255,0.38),
      0 0 65px rgba(133,193,233,0.55), 0 0 130px rgba(46,134,193,0.3);
    position:relative;
  }
  .planet-snow::before {
    content:''; position:absolute; inset:0; border-radius:50%;
    background:
      radial-gradient(ellipse 72% 22% at 40% 24%, rgba(255,255,255,0.48) 0%, transparent 55%),
      radial-gradient(ellipse 42% 14% at 62% 72%, rgba(214,234,248,0.32) 0%, transparent 55%),
      radial-gradient(circle 22px at 50% 50%, rgba(255,255,255,0.22) 0%, transparent 50%);
  }

  /* ══════════════════
     APP LAYOUT
  ══════════════════ */
  .app {
    max-width:1300px; margin:0 auto; padding:24px;
  }

  header {
    display:flex; flex-direction:column; gap:0;
    margin-bottom:20px; padding-bottom:0;
    position:relative;
  }
  .header-top {
    display:flex; align-items:center; justify-content:space-between;
    padding-bottom:16px;
    border-bottom:none;
    position:relative;
  }
  .header-top::before {
    content:'';
    position:absolute; bottom:0; left:0; right:0; height:1px;
    background:rgba(167,139,250,0.15);
  }
  .header-top::after {
    content:'';
    position:absolute; bottom:-1px; left:0; right:0; height:1px;
    background:linear-gradient(90deg, transparent, rgba(196,181,253,0.6), rgba(229,196,107,0.4), rgba(126,232,200,0.5), transparent);
  }
  .header-month-bar {
    display:flex; align-items:center; justify-content:center;
    gap:20px; padding:18px 0 24px;
  }

  .logo {
    position:relative;
  }
  .logo-orbit-wrap {
    position:relative;
    width:260px;
    height:130px;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:visible;
  }
  .logo-orbit-svg {
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    pointer-events:none;
    overflow:visible;
  }
  .logo-text {
    position:relative;
    z-index:2;
    display:flex;
    flex-direction:column;
    align-items:flex-start;
    gap:1px;
  }
  /* Line 1: AMETHY */
  .logo-line1 {
    font-family:'Cinzel Decorative', serif;
    font-size:26px; font-weight:900; letter-spacing:6px;
    color: #c4b5fd;
    text-shadow: 0 0 12px rgba(139,92,246,0.9), 0 0 28px rgba(109,40,217,0.6), 0 0 50px rgba(139,92,246,0.3);
    line-height:1.1;
  }
  /* Line 2: ST ◆  — plain color so it actually renders */
  .logo-line2 {
    display:flex; align-items:center; gap:6px;
    padding-left:4px;
    line-height:1;
  }
  .logo-st {
    font-family:'Cinzel', serif;
    font-size:13px; font-weight:700; letter-spacing:3px;
    color:#e2d9ff;
    opacity:0.85;
    text-shadow: 0 0 8px rgba(167,139,250,0.7);
  }
  .logo-gem {
    font-size:18px;
    color: #e879f9;
    opacity:0.65;
    filter: drop-shadow(0 0 8px rgba(232,121,249,0.9)) drop-shadow(0 0 16px rgba(168,85,247,0.7));
    animation: gemPulse 3s ease-in-out infinite alternate;
    will-change:opacity;
  }
  @keyframes gemPulse {
    0%   { opacity:0.45; }
    100% { opacity:0.8; }
  }
  /* Line 3: ASTROLABE */
  .logo-line3 {
    font-family:'Cinzel Decorative', serif;
    font-size:26px; font-weight:900; letter-spacing:6px;
    color: #fbbf24;
    text-shadow: 0 0 12px rgba(251,191,36,0.9), 0 0 28px rgba(229,196,107,0.6), 0 0 50px rgba(251,191,36,0.3);
    line-height:1.1;
  }


  .header-right { display:flex; align-items:center; gap:16px; align-self:center; }

  /* Planet switcher */
  .planet-switcher {
    display:flex; gap:6px; align-items:center;
  }
  .planet-dot {
    width:18px; height:18px; border-radius:50%;
    cursor:pointer; border:1.5px solid transparent;
    transition:all 0.35s cubic-bezier(.34,1.56,.64,1);
    opacity:0.6; position:relative; flex-shrink:0;
  }
  .planet-dot:hover { opacity:1; transform:scale(1.5); }
  .planet-dot.active { border-color:rgba(255,255,255,0.7); opacity:1; transform:scale(1.3); box-shadow:0 0 10px rgba(255,255,255,0.4); }
  /* per-planet mini textures */
  .planet-dot[data-p="0"]  { background:radial-gradient(circle at 38% 35%, #b3e5fc 0%, #4fc3f7 30%, #1976d2 60%, #0a2f6e 100%); box-shadow:0 0 6px rgba(79,195,247,0.5); }
  .planet-dot[data-p="1"]  { background:radial-gradient(circle at 40% 38%, #f08070 0%, #c0392b 35%, #7b1010 70%, #200000 100%); box-shadow:0 0 6px rgba(192,57,43,0.5); }
  .planet-dot[data-p="2"]  { background:radial-gradient(circle at 40% 40%, #fde8c8 0%, #e59866 25%, #a04000 55%, #3a1200 100%); box-shadow:0 0 6px rgba(229,152,102,0.5); }
  .planet-dot[data-p="3"]  { background:radial-gradient(circle at 38% 36%, #fde68a 0%, #c9a227 30%, #7a5c00 65%, #1f1600 100%); box-shadow:0 0 6px rgba(201,162,39,0.5); }
  .planet-dot[data-p="4"]  { background:radial-gradient(circle at 36% 34%, #a8d4f5 0%, #4a90d9 30%, #0d3d7a 65%, #010d20 100%); box-shadow:0 0 6px rgba(74,144,217,0.5); }
  .planet-dot[data-p="5"]  { background:radial-gradient(circle at 40% 38%, #ff9d4a 0%, #e63900 25%, #7a1800 55%, #150200 100%); box-shadow:0 0 8px rgba(230,57,0,0.65); }
  .planet-dot[data-p="6"]  { background:radial-gradient(circle at 40% 38%, #d7a8f5 0%, #9b59b6 25%, #4a235a 55%, #0f0018 100%); box-shadow:0 0 6px rgba(155,89,182,0.6); }
  .planet-dot[data-p="7"]  { background:radial-gradient(circle at 40% 37%, #fef3c7 0%, #f0c040 28%, #8b6400 60%, #251a00 100%); box-shadow:0 0 6px rgba(240,192,64,0.5); }
  .planet-dot[data-p="8"]  { background:radial-gradient(circle at 36% 32%, #b2f0f8 0%, #4dd0e1 28%, #005662 62%, #000f12 100%); box-shadow:0 0 6px rgba(77,208,225,0.55); }
  .planet-dot[data-p="9"]  { background:radial-gradient(circle at 38% 35%, #c8f590 0%, #56ab2f 28%, #1a5c0d 62%, #030d00 100%); box-shadow:0 0 6px rgba(86,171,47,0.5); }
  .planet-dot[data-p="10"] { background:radial-gradient(circle at 38% 36%, #fde8b5 0%, #e8a838 28%, #753210 62%, #1a0500 100%); box-shadow:0 0 6px rgba(232,168,56,0.5); }
  .planet-dot[data-p="11"] { background:radial-gradient(circle at 35% 32%, #eaf4fd 0%, #85c1e9 25%, #1a5276 60%, #030c18 100%); box-shadow:0 0 7px rgba(133,193,233,0.6); }

  .header-nav { display:flex; gap:8px; }

  .btn {
    font-family:'Orbitron', monospace; font-size:10px; letter-spacing:2px;
    padding:10px 20px; border:1px solid rgba(167,139,250,0.5);
    background:rgba(109,40,217,0.1); color:#c4b5fd; cursor:pointer; transition:all 0.3s;
    clip-path:polygon(8px 0%,100% 0%,calc(100% - 8px) 100%,0% 100%);
  }
  .btn:hover { background:linear-gradient(135deg,rgba(139,92,246,0.4),rgba(99,102,241,0.3)); color:#e8e0ff; box-shadow:0 0 20px rgba(139,92,246,0.4); border-color:rgba(196,181,253,0.7); }
  .btn.accent2 { border-color:rgba(244,114,182,0.5); color:#f9a8d4; background:rgba(244,114,182,0.08); }
  .btn.accent2:hover { background:linear-gradient(135deg,rgba(244,114,182,0.3),rgba(236,72,153,0.2)); box-shadow:var(--glow2); border-color:rgba(249,168,212,0.7); }

  .header-month-bar { display:flex; align-items:center; justify-content:center; gap:20px; padding:14px 0 22px; }
  .month-title {
    font-family:'Cormorant SC', serif; font-size:32px; font-weight:700;
    letter-spacing:10px; min-width:320px; text-align:center;
    display:flex; align-items:baseline; justify-content:center; gap:12px;
  }
  .month-title {
    font-family:'Cormorant SC', serif;
    letter-spacing:10px; text-align:center;
    display:flex; align-items:baseline; justify-content:center; gap:12px;
  }
  .month-name {
    font-family:'Cormorant SC', serif;
    font-size:32px; font-weight:700; letter-spacing:10px;
    color: #c4b5fd;
    transition: color 0.5s ease, text-shadow 0.5s ease;
  }
  .month-title .year {
    font-family:'Cormorant SC', serif;
    font-size:16px; font-weight:800; letter-spacing:4px;
    color: #9d8ec0;
    transition: color 0.5s ease;
  }
  .nav-btn {
    width:40px; height:40px; border:1px solid rgba(167,139,250,0.3); background:rgba(109,40,217,0.08);
    color:#c4b5fd; cursor:pointer; font-size:18px;
    display:flex; align-items:center; justify-content:center; transition:all 0.3s;
    clip-path:polygon(6px 0%,100% 0%,calc(100% - 6px) 100%,0% 100%);
  }
  .nav-btn:hover { border-color:rgba(196,181,253,0.7); box-shadow:0 0 16px rgba(139,92,246,0.4); color:#e0d9ff; }

  .main { display:grid; grid-template-columns:1fr 320px; gap:20px; }

  .calendar-wrap {
    background:linear-gradient(135deg, var(--bg2) 0%, var(--bg3) 100%);
    border:1px solid rgba(167,139,250,0.2); overflow:hidden; position:relative;
    box-shadow:0 0 40px rgba(109,40,217,0.1);
  }
  .calendar-wrap::after {
    content:''; position:absolute; left:0; right:0; height:1px; top:0;
    background:linear-gradient(90deg,transparent,#c4b5fd,#e5c46b,#7ee8c8,transparent);
    opacity:0.15; animation:scanline 7s linear infinite; pointer-events:none;
    will-change:transform, opacity;
  }
  @keyframes scanline { 0%{transform:translateY(0);opacity:0.3;} 50%{opacity:0.05;} 100%{transform:translateY(100vh);opacity:0.3;} }

  .weekdays { display:grid; grid-template-columns:repeat(7,1fr); background:rgba(109,40,217,0.07); border-bottom:1px solid rgba(167,139,250,0.15); }
  .weekday { text-align:center; padding:14px 4px; font-family:'Orbitron',monospace; font-size:10px; letter-spacing:2px; color:#9b8fd4; }
  .weekday.weekend { color:#f472b6; opacity:0.8; }

  .days-grid { display:grid; grid-template-columns:repeat(7,1fr); contain:layout style; }

  .day-cell {
    min-height:110px; border-right:1px solid var(--border); border-bottom:1px solid var(--border);
    padding:8px 6px; cursor:pointer; transition:background 0.2s; position:relative; overflow:hidden;
  }
  .day-cell:nth-child(7n) { border-right:none; }
  .day-cell:hover { background:rgba(109,40,217,0.07); }
  .day-cell.today { background:rgba(109,40,217,0.1); }
  .day-cell.today .day-num { color:#c4b5fd; text-shadow:0 0 12px rgba(167,139,250,0.7); }
  .day-cell.other-month .day-num { color:rgba(107,125,160,0.3); }
  .day-cell.other-month { background:rgba(0,0,0,0.2); }
  .day-cell.selected { background:rgba(109,40,217,0.14); border-color:rgba(167,139,250,0.4) !important; }

  .day-num { font-family:'Orbitron',monospace; font-size:13px; font-weight:700; color:var(--text); margin-bottom:6px; display:block; line-height:1; }
  .today-dot { display:inline-block; width:6px; height:6px; background:linear-gradient(135deg,#c4b5fd,#e5c46b); border-radius:50%; box-shadow:0 0 8px rgba(167,139,250,0.8); margin-left:4px; vertical-align:middle; }

  .event-chip {
    font-size:10px; padding:2px 6px; margin-bottom:2px; border-left:2px solid;
    background:rgba(0,0,0,0.3); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    cursor:pointer; transition:all 0.2s; display:block;
  }
  .event-chip:hover { transform:translateX(2px); }

  .task-bar {
    font-size:9px; letter-spacing:0.5px; padding:2px 6px; margin-bottom:2px;
    border-radius:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    cursor:pointer; opacity:0.9; transition:opacity 0.2s; display:block;
  }
  .task-bar:hover { opacity:1; }
  .task-bar.start  { border-radius:10px 2px 2px 10px; }
  .task-bar.end    { border-radius:2px 10px 10px 2px; }
  .task-bar.middle { border-radius:0; }
  .task-bar.single { border-radius:10px; }

  /* ── SIDEBAR ── */
  .sidebar { display:flex; flex-direction:column; gap:16px; }
  .panel {
    background:linear-gradient(135deg, var(--bg2) 0%, var(--bg3) 100%);
    border:1px solid var(--border); padding:20px;
    box-shadow:0 0 20px rgba(0,0,0,0.3);
  }
  .panel-title {
    font-family:'Orbitron',monospace; font-size:11px; letter-spacing:3px;
    color: #b8a8e8;
    margin-bottom:16px; padding-bottom:10px;
    border-bottom:1px solid var(--border); display:flex; align-items:center; gap:8px;
  }
  .panel-title .dot { width:6px; height:6px; border-radius:50%; background:var(--accent1); box-shadow:var(--glow1); }

  .event-list,.task-list { display:flex; flex-direction:column; gap:8px; max-height:200px; overflow-y:auto; }
  .task-list { max-height:260px; }
  .event-list::-webkit-scrollbar,.task-list::-webkit-scrollbar { width:4px; }
  .event-list::-webkit-scrollbar-track,.task-list::-webkit-scrollbar-track { background:var(--bg); }
  .event-list::-webkit-scrollbar-thumb { background:var(--accent3); }
  .task-list::-webkit-scrollbar-thumb { background:var(--accent2); }

  .event-item { display:flex; align-items:flex-start; gap:10px; padding:10px; background:rgba(0,0,0,0.3); border-left:3px solid; cursor:pointer; transition:all 0.2s; }
  .event-item:hover { background:rgba(0,245,255,0.05); transform:translateX(3px); }
  .event-item-info { flex:1; overflow:hidden; }
  .event-item-name { font-size:12px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .event-item-meta { font-size:10px; color:var(--text-dim); margin-top:2px; }
  .event-item-del { background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:14px; padding:0 2px; transition:color 0.2s; opacity:0; }
  .event-item:hover .event-item-del { opacity:1; }
  .event-item-del:hover { color:var(--accent2); }

  .task-item { padding:10px; background:rgba(0,0,0,0.3); border-left:3px solid; cursor:pointer; transition:all 0.2s; }
  .task-item:hover { background:rgba(255,0,110,0.05); transform:translateX(3px); }
  .task-item-name { font-size:12px; font-weight:500; margin-bottom:4px; }
  .task-item-dates { font-size:10px; color:var(--text-dim); }
  .task-item-del { float:right; background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:14px; opacity:0; transition:all 0.2s; }
  .task-item:hover .task-item-del { opacity:1; }
  .task-item-del:hover { color:var(--accent2); }
  .task-progress { height:3px; background:rgba(255,255,255,0.1); margin-top:6px; border-radius:2px; overflow:hidden; }
  .task-progress-fill { height:100%; border-radius:2px; transition:width 0.5s ease; }

  .empty-state { text-align:center; color:var(--text-dim); font-size:11px; padding:20px; letter-spacing:1px; }
  .selected-info { font-family:'Orbitron',monospace; font-size:10px; color:var(--text-dim); letter-spacing:1px; margin-bottom:12px; }

  /* ── MODAL ── */
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(2,4,15,0.92); z-index:100; align-items:center; justify-content:center; }
  .modal-overlay.active { display:flex; }
  .modal {
    background:linear-gradient(135deg,#0d1428 0%,#131e35 100%);
    border:1px solid var(--accent1); padding:32px; width:440px; max-width:95vw;
    box-shadow:0 0 60px rgba(0,245,255,0.2),0 0 120px rgba(0,0,0,0.5);
    position:relative;
    clip-path:polygon(0 0,calc(100% - 20px) 0,100% 20px,100% 100%,20px 100%,0 calc(100% - 20px));
    animation:modalIn 0.3s ease;
  }
  @keyframes modalIn { from{opacity:0;transform:scale(0.9) translateY(-20px);} to{opacity:1;transform:scale(1) translateY(0);} }
  .modal-title { font-family:'Orbitron',monospace; font-size:14px; letter-spacing:3px; color:var(--accent1); margin-bottom:24px; text-shadow:var(--glow1); }
  .form-group { margin-bottom:16px; }
  .form-label { display:block; font-family:'Orbitron',monospace; font-size:9px; letter-spacing:2px; color:var(--text-dim); margin-bottom:6px; }
  .form-input,.form-select {
    width:100%; background:rgba(0,0,0,0.5); border:1px solid var(--border); color:var(--text);
    padding:10px 12px; font-family:'Noto Sans SC',sans-serif; font-size:13px; transition:border-color 0.3s; outline:none;
    clip-path:polygon(4px 0%,100% 0%,calc(100% - 4px) 100%,0% 100%);
  }
  .form-input:focus { border-color:var(--accent1); box-shadow:var(--glow1); }
  .form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
  .color-picker { display:flex; gap:8px; flex-wrap:wrap; }
  .color-opt { width:28px; height:28px; border-radius:50%; cursor:pointer; border:2px solid transparent; transition:all 0.2s; }
  .color-opt:hover { transform:scale(1.2); }
  .color-opt.selected { border-color:white; box-shadow:0 0 10px rgba(255,255,255,0.5); }
  .modal-actions { display:flex; gap:10px; margin-top:24px; justify-content:flex-end; }
  .modal-close { position:absolute; top:16px; right:16px; background:none; border:none; color:var(--text-dim); font-size:20px; cursor:pointer; transition:color 0.2s; }
  .modal-close:hover { color:var(--accent2); }

  /* ── AUTH OVERLAY ── */
  #auth-overlay { position:fixed; inset:0; z-index:9999; background:#04060f; display:flex; align-items:center; justify-content:center; flex-direction:column; transition:opacity 0.8s ease; }
  #auth-overlay.hidden { opacity:0; pointer-events:none; }
  .auth-box { width:360px; padding:40px; background:linear-gradient(135deg, rgba(13,20,40,0.9), rgba(19,30,53,0.95)); border:1px solid var(--accent1); box-shadow:0 0 60px rgba(167,139,250,0.25), 0 0 120px rgba(109,40,217,0.15); text-align:center; position:relative; clip-path:polygon(0 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%); }
  .auth-title { font-family:'Cinzel Decorative'; font-size:28px; color:#c4b5fd; margin-bottom:6px; text-shadow:0 0 16px rgba(167,139,250,0.7), 0 0 40px rgba(109,40,217,0.4); }
  .auth-astrolabe { font-family:'Cinzel Decorative'; font-size:20px; color:#fbbf24; text-shadow:0 0 12px rgba(251,191,36,0.7); margin-bottom:8px; }
  .auth-sub { font-family:'Orbitron'; font-size:9px; color:var(--text-dim); letter-spacing:3px; margin-bottom:32px; }
  .auth-input { width:100%; background:rgba(0,0,0,0.4); border:1px solid rgba(167,139,250,0.2); color:white; padding:12px 14px; margin-bottom:14px; outline:none; font-family:'Orbitron'; font-size:11px; letter-spacing:1px; transition:all 0.3s; }
  .auth-input:focus { border-color:var(--accent1); box-shadow:0 0 15px rgba(167,139,250,0.3); }
  .auth-btn { width:100%; padding:13px; background:linear-gradient(90deg, #4c1d95, #6366f1, #a78bfa); border:none; color:white; font-family:'Orbitron'; font-size:10px; font-weight:bold; letter-spacing:2px; cursor:pointer; margin-top:8px; transition:all 0.3s; clip-path:polygon(6px 0%,100% 0%,calc(100% - 6px) 100%,0% 100%); }
  .auth-btn:hover { box-shadow:0 0 25px rgba(167,139,250,0.6); letter-spacing:3px; }
  .auth-msg { font-family:'Orbitron'; font-size:10px; color:var(--accent2); margin-top:14px; min-height:16px; letter-spacing:1px; }
  .switch-mode { font-family:'Orbitron'; font-size:9px; color:var(--text-dim); margin-top:18px; cursor:pointer; letter-spacing:1px; opacity:0.7; }
  .switch-mode:hover { color:#c4b5fd; opacity:1; }
  /* Logout */
  #logoutBtn { position:fixed; top:20px; right:24px; z-index:200; font-family:'Orbitron'; font-size:9px; letter-spacing:1px; background:rgba(109,40,217,0.1); border:1px solid rgba(167,139,250,0.3); color:#c4b5fd; padding:7px 14px; cursor:pointer; display:none; clip-path:polygon(6px 0%,100% 0%,calc(100% - 6px) 100%,0% 100%); transition:all 0.3s; }
  #logoutBtn:hover { background:rgba(239,68,68,0.15); border-color:rgba(239,68,68,0.4); color:#fca5a5; }
  /* App fade-in */
  .app { opacity:0; transition:opacity 1s ease; pointer-events:none; }
  .app.visible { opacity:1; pointer-events:auto; }
  /* User email tag */
  .user-tag { font-family:'Orbitron'; font-size:9px; color:var(--text-dim); letter-spacing:1px; opacity:0.6; margin-left:8px; }


  /* ── SCROLL PICKER ── */
  .scroll-picker-row {
    display:flex; align-items:center; gap:8px;
    background:rgba(0,0,0,0.35); border:1px solid var(--border);
    padding:6px 12px; position:relative;
  }
  /* center highlight band */
  .scroll-picker-row::after {
    content:''; pointer-events:none;
    position:absolute; left:12px; right:12px;
    top:50%; transform:translateY(-50%);
    height:36px;
    border-top:1px solid rgba(167,139,250,0.35);
    border-bottom:1px solid rgba(167,139,250,0.35);
    background:rgba(109,40,217,0.08);
  }
  .scroll-col-sep {
    color:var(--text-dim); font-family:'Orbitron'; font-size:13px;
    user-select:none; flex-shrink:0; position:relative; z-index:2;
  }
  .scroll-col {
    height:108px; overflow-y:scroll; flex:1;
    scrollbar-width:none;
    scroll-snap-type:y mandatory;
    scroll-behavior:auto;
    -webkit-overflow-scrolling:touch;
    position:relative; z-index:1;
  }
  .scroll-col::-webkit-scrollbar { display:none; }
  /* fade top/bottom with pseudo on wrapper instead */
  .scroll-picker-row::before {
    content:''; pointer-events:none;
    position:absolute; left:0; right:0; top:0; height:36px;
    background:linear-gradient(to bottom, rgba(8,12,28,0.92), transparent);
    z-index:3;
  }
  .scroll-fade-bottom {
    position:absolute; left:0; right:0; bottom:0; height:36px;
    background:linear-gradient(to top, rgba(8,12,28,0.92), transparent);
    pointer-events:none; z-index:3;
  }
  .scroll-item {
    height:36px; display:flex; align-items:center; justify-content:center;
    font-family:'Orbitron'; font-size:11px; letter-spacing:1px;
    color:rgba(107,125,160,0.7);
    scroll-snap-align:center;
    user-select:none; cursor:pointer;
    will-change:auto;
  }
  .scroll-item.active {
    color:#e8e0ff; font-size:13px;
    text-shadow:0 0 8px rgba(167,139,250,0.7);
  }

</style>
</head>
<body>

<!-- PLANET STAGE -->

<div id="auth-overlay">
  <div class="auth-box">
    <div class="auth-title">AMETHY</div>
    <div class="auth-astrolabe">ASTROLABE</div>
    <div class="auth-sub">✦ &nbsp; IDENTITY VERIFICATION &nbsp; ✦</div>
    <input type="email" id="authEmail" class="auth-input" placeholder="EMAIL ADDRESS">
    <input type="password" id="authPassword" class="auth-input" placeholder="PASSWORD">
    <button class="auth-btn" id="loginActionBtn">ENTER THE ARCHIVE</button>
    <div class="auth-msg" id="authMsg"></div>
    <div class="switch-mode" id="switchModeBtn">No account? Click to Register</div>
  </div>
</div>

<button id="logoutBtn">DISCONNECT</button>

<div id="planet-stage">
  <!-- Jan: Earth -->
  <div class="planet-wrap" id="p-0">
    <div class="planet-earth"></div>
    <div class="planet-label">TERRA</div>
  </div>
  <!-- Feb: Mars -->
  <div class="planet-wrap" id="p-1">
    <div class="planet-mars"></div>
    <div class="planet-label">ARES</div>
  </div>
  <!-- Mar: Jupiter -->
  <div class="planet-wrap" id="p-2">
    <div class="planet-jupiter"></div>
    <div class="planet-label">ZEUS</div>
  </div>
  <!-- Apr: Saturn -->
  <div class="planet-wrap" id="p-3">
    <div class="saturn-wrap">
      <div class="saturn-ring2"></div>
      <div class="saturn-ring"></div>
      <div class="saturn-globe"></div>
    </div>
    <div class="planet-label">KRONOS</div>
  </div>
  <!-- May: Neptune -->
  <div class="planet-wrap" id="p-4">
    <div class="planet-neptune"></div>
    <div class="planet-label">POSEIDON</div>
  </div>
  <!-- Jun: Lava -->
  <div class="planet-wrap" id="p-5">
    <div class="planet-lava"></div>
    <div class="planet-label">VULCAN</div>
  </div>
  <!-- Jul: Forest -->
  <div class="planet-wrap" id="p-6">
    <div class="planet-storm"></div>
    <div class="planet-label">TEMPEST</div>
  </div>
  <!-- Aug: Desert -->
  <div class="planet-wrap" id="p-7">
    <div class="planet-desert"></div>
    <div class="planet-label">SAHARA</div>
  </div>
  <!-- Sep: Crystal -->
  <div class="planet-wrap" id="p-8">
    <div class="planet-crystal"></div>
    <div class="planet-label">AURORA</div>
  </div>
  <!-- Oct: Storm -->
  <div class="planet-wrap" id="p-9">
    <div class="planet-forest"></div>
    <div class="planet-label">GAIA</div>
  </div>
  <!-- Nov: Exotic + moon -->
  <div class="planet-wrap" id="p-10">
    <div class="exotic-wrap">
      <div class="planet-exotic"></div>
      <div class="moon-small"></div>
    </div>
    <div class="planet-label">KEPLER</div>
  </div>
  <!-- Dec: Snow -->
  <div class="planet-wrap" id="p-11">
    <div class="planet-snow"></div>
    <div class="planet-label">BOREAS</div>
  </div>
</div>

<div class="app" id="mainApp">
  <header>
    <div class="header-top">
      <div class="logo">
        <!-- orbital ring surrounds the text block -->
        <div class="logo-orbit-wrap" aria-hidden="true">
          <svg class="logo-orbit-svg" viewBox="0 0 260 130" fill="none" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <linearGradient id="og1" x1="0" y1="0" x2="1" y2="0">
                <stop offset="0%"   stop-color="#6366f1" stop-opacity="0.08"/>
                <stop offset="25%"  stop-color="#a78bfa" stop-opacity="0.55"/>
                <stop offset="50%"  stop-color="#e5c46b" stop-opacity="0.65"/>
                <stop offset="75%"  stop-color="#7ee8c8" stop-opacity="0.5"/>
                <stop offset="100%" stop-color="#6366f1" stop-opacity="0.08"/>
              </linearGradient>
            </defs>
            <!-- main ellipse orbit -->
            <ellipse cx="130" cy="65" rx="124" ry="58"
              stroke="url(#og1)" stroke-width="0.9" fill="none" opacity="0.7"/>
            <!-- tick marks at cardinal points -->
            <line x1="6"   y1="65"  x2="12"  y2="65"  stroke="#a78bfa" stroke-width="0.8" opacity="0.5"/>
            <line x1="254" y1="65"  x2="248" y2="65"  stroke="#a78bfa" stroke-width="0.8" opacity="0.5"/>
            <line x1="130" y1="7"   x2="130" y2="13"  stroke="#e5c46b" stroke-width="0.8" opacity="0.5"/>
            <line x1="130" y1="123" x2="130" y2="117" stroke="#e5c46b" stroke-width="0.8" opacity="0.5"/>
            <!-- fixed small stars on orbit -->
            <circle cx="6"   cy="65"  r="1.8" fill="#a78bfa" opacity="0.8"/>
            <circle cx="254" cy="65"  r="1.8" fill="#a78bfa" opacity="0.8"/>
            <circle cx="130" cy="7"   r="2"   fill="#e5c46b" opacity="0.9"/>
            <circle cx="130" cy="123" r="1.6" fill="#7ee8c8" opacity="0.75"/>
            <circle cx="60"  cy="18"  r="1.2" fill="#c4b5fd" opacity="0.6"/>
            <circle cx="200" cy="18"  r="1.2" fill="#c4b5fd" opacity="0.6"/>
            <circle cx="42"  cy="100" r="1"   fill="#e5c46b" opacity="0.5"/>
            <circle cx="218" cy="100" r="1"   fill="#7ee8c8" opacity="0.5"/>
            <!-- travelling comet along orbit -->
            <circle r="2.5" fill="#f0abfc" opacity="0">
              <animateMotion dur="9s" repeatCount="indefinite">
                <mpath href="#orbitPath"/>
              </animateMotion>
              <animate attributeName="opacity" values="0;0;1;1;1;0" keyTimes="0;0.05;0.1;0.85;0.92;1" dur="9s" repeatCount="indefinite"/>
            </circle>
            <!-- invisible path for animateMotion reference -->
            <path id="orbitPath" d="M 130 7 A 124 58 0 1 1 129.9 7" fill="none" stroke="none"/>
          </svg>
          <!-- the actual text sits inside the orbit -->
          <div class="logo-text">
            <div class="logo-line1">AMETHY <span class="user-tag" id="userEmailDisplay"></span></div>
            <div class="logo-line2"><span class="logo-st">ST</span><span class="logo-gem">◆</span></div>
            <div class="logo-line3">ASTROLABE</div>
          </div>
        </div>
      </div>
      <div class="header-right">
        <div class="planet-switcher" id="planetSwitcher"></div>
        <div class="header-nav">
          <button class="btn" id="openEventModal">+ 日程</button>
          <button class="btn accent2" id="openTaskModal">+ 任务</button>
        </div>
      </div>
    </div>
    <div class="header-month-bar">
      <button class="nav-btn" id="prevMonth">&#8249;</button>
      <div class="month-title" id="monthTitle"></div>
      <button class="nav-btn" id="nextMonth">&#8250;</button>
    </div>
  </header>

  <div class="main">
    <div class="calendar-wrap" id="calendarWrap">
      <div class="weekdays">
        <div class="weekday">SUN</div><div class="weekday">MON</div><div class="weekday">TUE</div>
        <div class="weekday">WED</div><div class="weekday">THU</div><div class="weekday">FRI</div>
        <div class="weekday weekend">SAT</div>
      </div>
      <div class="days-grid" id="daysGrid"></div>
    </div>

    <div class="sidebar">
      <div class="panel" id="alchemyPanel">
        <div class="panel-title"><span class="dot" style="background:var(--gold);box-shadow:0 0 8px rgba(229,196,107,0.8)"></span>DAILY ALCHEMY</div>
        <div id="alchemyContent" style="font-size:11px;line-height:1.7;color:#d4c8f0;font-style:italic;letter-spacing:0.5px;padding:4px 0;min-height:60px;display:flex;align-items:center;justify-content:center;">
          <span style="color:var(--text-dim);letter-spacing:1px;font-size:10px">✦ &nbsp; transmuting wisdom &nbsp; ✦</span>
        </div>
      </div>
      <div class="panel">
        <div class="panel-title"><span class="dot"></span>TODAY <button id="quickAddForDay" onclick="openEventModal(null, this.dataset.date)" style="display:none;margin-left:auto;font-family:'Orbitron';font-size:8px;letter-spacing:1px;background:rgba(109,40,217,0.2);border:1px solid rgba(167,139,250,0.4);color:#c4b5fd;padding:3px 8px;cursor:pointer">+ ADD</button></div>
        <div class="selected-info" id="todayInfo"></div>
        <div id="todayEvents" class="event-list"><div class="empty-state">// 暂无日程 //</div></div>
      </div>
      <div class="panel">
        <div class="panel-title"><span class="dot" style="background:var(--accent1)"></span>ALL EVENTS</div>
        <div class="event-list" id="allEventsList"><div class="empty-state">// 暂无日程 //</div></div>
      </div>
      <div class="panel">
        <div class="panel-title"><span class="dot" style="background:var(--accent2);box-shadow:var(--glow2)"></span>TASKS</div>
        <div class="task-list" id="allTasksList"><div class="empty-state">// 暂无任务 //</div></div>
      </div>
    </div>
  </div>
</div>

<!-- Event Modal -->
<div class="modal-overlay" id="eventModalOverlay">
  <div class="modal">
    <button class="modal-close" id="closeEventModal">✕</button>
    <div class="modal-title" id="eventModalTitle">// ADD EVENT //</div>
    <input type="hidden" id="editingEventId">

    <div class="form-group">
      <label class="form-label" for="eventName">日程名称</label>
      <input type="text" class="form-input" id="eventName" placeholder="输入日程名称...">
    </div>

    <div class="form-group">
      <label class="form-label" for="eventLocation">地点（可选）</label>
      <input type="text" class="form-input" id="eventLocation" placeholder="输入地点...">
    </div>

    <div class="form-group">
      <label class="form-label" for="datePicker">日期</label>
      <div class="scroll-picker-row" id="datePicker"><div class="scroll-fade-bottom"></div>
        <div class="scroll-col" id="yearCol"></div>
        <div class="scroll-col-sep">—</div>
        <div class="scroll-col" id="monthCol"></div>
        <div class="scroll-col-sep">—</div>
        <div class="scroll-col" id="dayCol"></div>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label" for="timePicker">时间（可选）</label>
      <div class="scroll-picker-row" id="timePicker"><div class="scroll-fade-bottom"></div>
        <div class="scroll-col" id="hourCol"></div>
        <div class="scroll-col-sep">:</div>
        <div class="scroll-col" id="minuteCol"></div>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label" for="eventColorPicker">颜色标签</label>
      <div class="color-picker" id="eventColorPicker">
        <div class="color-opt selected" style="background:#00f5ff" data-color="#00f5ff"></div>
        <div class="color-opt" style="background:#7b2fff" data-color="#7b2fff"></div>
        <div class="color-opt" style="background:#00ff9d" data-color="#00ff9d"></div>
        <div class="color-opt" style="background:#ffb800" data-color="#ffb800"></div>
        <div class="color-opt" style="background:#ff006e" data-color="#ff006e"></div>
        <div class="color-opt" style="background:#ff7b00" data-color="#ff7b00"></div>
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn" id="saveEvent">CONFIRM</button>
      <button class="btn" id="deleteEditingEvent" style="display:none;background:rgba(255,0,110,0.1);border-color:rgba(255,0,110,0.4);color:#f9a8d4;margin-left:8px">DELETE</button>
    </div>
  </div>
</div>

<!-- Task Modal -->
<div class="modal-overlay" id="taskModalOverlay">
  <div class="modal" style="border-color:var(--accent2);box-shadow:0 0 60px rgba(255,0,110,0.2)">
    <button class="modal-close" id="closeTaskModal">✕</button>
    <div class="modal-title" style="color:var(--accent2)">// ADD TASK //</div>
    <div class="form-group"><label class="form-label" for="taskName">任务名称</label><input type="text" class="form-input" id="taskName" placeholder="输入任务名称..."></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label" for="taskStart">开始日期</label><input type="date" class="form-input" id="taskStart"></div>
      <div class="form-group"><label class="form-label" for="taskEnd">截止日期 DDL</label><input type="date" class="form-input" id="taskEnd"></div>
    </div>
    <div class="form-group">
      <label class="form-label" for="taskColorPicker">颜色标签</label>
      <div class="color-picker" id="taskColorPicker">
        <div class="color-opt selected" style="background:#ff006e" data-color="#ff006e"></div>
        <div class="color-opt" style="background:#ff7b00" data-color="#ff7b00"></div>
        <div class="color-opt" style="background:#ffb800" data-color="#ffb800"></div>
        <div class="color-opt" style="background:#7b2fff" data-color="#7b2fff"></div>
        <div class="color-opt" style="background:#00f5ff" data-color="#00f5ff"></div>
        <div class="color-opt" style="background:#00ff9d" data-color="#00ff9d"></div>
      </div>
    </div>
    <div class="modal-actions"><button class="btn accent2" id="saveTask">CONFIRM</button></div>
  </div>
</div>


<script>
  // ── VISIBLE DEBUG HELPER ──
  function dbg(...args) {
    console.log(...args);
    const panel = document.getElementById('debugPanel');
    const log = document.getElementById('debugLog');
    if (!panel || !log) return;
    panel.style.display = 'block';
    const line = document.createElement('div');
    line.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
    line.style.padding = '2px 0';
    line.textContent = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
    log.appendChild(line);
    panel.scrollTop = panel.scrollHeight;
  }

  let currentDate = new Date();
  let currentYear = currentDate.getFullYear();
  let currentMonth = currentDate.getMonth();

  // Data lives in Supabase — never use localStorage for events/tasks
  let events = [];
  let tasks  = [];
  // Clear any stale local data that could interfere
  try { localStorage.removeItem('chrono_events'); localStorage.removeItem('chrono_tasks'); } catch(e) {}

  const MONTHS_ZH = ['JANUARY','FEBRUARY','MARCH','APRIL','MAY','JUNE','JULY','AUGUST','SEPTEMBER','OCTOBER','NOVEMBER','DECEMBER'];
  
  const PLANETS = [
    { id:'p-0',  name:'TERRA',    color:'#4fc3f7', grad:['#1976d2','#4fc3f7','#b3e5fc'], glow:'79,195,247' },
    { id:'p-1',  name:'ARES',     color:'#e05050', grad:['#c0392b','#e8705a','#ffc0b0'], glow:'220,80,70'  },
    { id:'p-2',  name:'ZEUS',     color:'#e59866', grad:['#a04000','#e59866','#fde8c8'], glow:'229,152,102'},
    { id:'p-3',  name:'KRONOS',   color:'#c9a227', grad:['#7a5c00','#c9a227','#fde68a'], glow:'201,162,39' },
    { id:'p-4',  name:'POSEIDON', color:'#4a90d9', grad:['#0d3d7a','#4a90d9','#a8d4f5'], glow:'74,144,217' },
    { id:'p-5',  name:'VULCAN',   color:'#e63900', grad:['#7a1800','#e63900','#ff9d4a'], glow:'230,57,0'   },
    { id:'p-6',  name:'TEMPEST',  color:'#9b59b6', grad:['#4a235a','#9b59b6','#d7a8f5'], glow:'155,89,182' },
    { id:'p-7',  name:'SAHARA',   color:'#f0c040', grad:['#8b6400','#f0c040','#fef3c7'], glow:'240,192,64' },
    { id:'p-8',  name:'AURORA',   color:'#4dd0e1', grad:['#005662','#4dd0e1','#b2f0f8'], glow:'77,208,225' },
    { id:'p-9',  name:'GAIA',     color:'#6dcf40', grad:['#2a7a10','#6dcf40','#c8f590'], glow:'109,207,64' },
    { id:'p-10', name:'KEPLER',   color:'#e8a838', grad:['#753210','#e8a838','#fde8b5'], glow:'232,168,56' },
    { id:'p-11', name:'BOREAS',   color:'#85c1e9', grad:['#1a5276','#85c1e9','#eaf4fd'], glow:'133,193,233'},
  ];

  // Build planet switcher dots
  const switcher = document.getElementById('planetSwitcher');
  PLANETS.forEach((p, i) => {
    const dot = document.createElement('div');
    dot.className = 'planet-dot';
    dot.dataset.p = i;
    dot.title = p.name;
    dot.addEventListener('click', () => {
      currentMonth = i;
      renderCalendar();
    });
    switcher.appendChild(dot);
  });

  function showPlanet(monthIdx) {
    const p = PLANETS[monthIdx];

    // Toggle planet visuals
    PLANETS.forEach((pl, i) => {
      document.getElementById(pl.id).classList.toggle('visible', i === monthIdx);
    });
    document.querySelectorAll('.planet-dot').forEach((d, i) => {
      d.classList.toggle('active', i === monthIdx);
    });

    // Solid color + glow — no background-clip, works in all environments
    const titleEl = document.getElementById('monthTitle');
    const nameSpan = titleEl.querySelector('.month-name');
    if (nameSpan) {
      nameSpan.style.color = p.grad[2];
      nameSpan.style.textShadow = `0 0 16px rgba(${p.glow},0.85), 0 0 36px rgba(${p.glow},0.5), 0 0 70px rgba(${p.glow},0.25)`;
    }
    const yearSpan = titleEl.querySelector('.year');
    if (yearSpan) yearSpan.style.color = p.grad[1];
  }

  function save() { /* data persisted via Supabase */ }

  function toDateStr(y, m, d) {
    return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  }
  function parseDate(str) {
    const [y,m,d] = str.split('-').map(Number);
    return new Date(y, m-1, d);
  }

  function renderCalendar() {
    document.getElementById('monthTitle').innerHTML =
      `<span class="month-name">${MONTHS_ZH[currentMonth]}</span><span class="year">${currentYear}</span>`;

    showPlanet(currentMonth);

    const grid = document.getElementById('daysGrid');
    grid.innerHTML = '';

    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth+1, 0).getDate();
    const daysInPrev  = new Date(currentYear, currentMonth, 0).getDate();
    const todayStr = toDateStr(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());

    for (let i = 0; i < 42; i++) {
      let day, month, year, isOther = false;
      if (i < firstDay) {
        day = daysInPrev - firstDay + 1 + i;
        month = currentMonth - 1; year = currentYear;
        if (month < 0) { month = 11; year--; }
        isOther = true;
      } else if (i - firstDay < daysInMonth) {
        day = i - firstDay + 1; month = currentMonth; year = currentYear;
      } else {
        day = i - firstDay - daysInMonth + 1;
        month = currentMonth + 1; year = currentYear;
        if (month > 11) { month = 0; year++; }
        isOther = true;
      }

      const dateStr = toDateStr(year, month, day);
      const isToday = dateStr === todayStr;

      const cell = document.createElement('div');
      cell.className = 'day-cell' + (isOther ? ' other-month':'') + (isToday ? ' today':'');
      cell.dataset.date = dateStr;

      const numEl = document.createElement('span');
      numEl.className = 'day-num';
      numEl.textContent = day;
      if (isToday) { const dot=document.createElement('span'); dot.className='today-dot'; numEl.appendChild(dot); }
      cell.appendChild(numEl);

      events.filter(e => e.date === dateStr).forEach(ev => {
        const chip = document.createElement('span');
        chip.className = 'event-chip';
        chip.style.borderColor = ev.color;
        chip.style.color = ev.color;
        chip.style.cursor = 'pointer';
        chip.textContent = (ev.time ? ev.time+' ':'')+ev.name;
        chip.addEventListener('click', e => {
          e.stopPropagation();
          const fresh = events.find(x => String(x.id) === String(ev.id));
          if (fresh) openEventModal(fresh);
        });
        cell.appendChild(chip);
      });

      tasks.forEach(task => {
        const start = parseDate(task.start), end = parseDate(task.end), cur = parseDate(dateStr);
        if (cur >= start && cur <= end) {
          const bar = document.createElement('span');
          const isStart = task.start === dateStr, isEnd = task.end === dateStr;
          bar.className = 'task-bar '+(isStart&&isEnd?'single':isStart?'start':isEnd?'end':'middle');
          bar.style.background = task.color;
          bar.style.color = '#000';
          bar.style.fontWeight = '600';
          bar.textContent = isStart ? ('⬤ '+task.name) : isEnd ? (task.name+' ✕') : '─────';
          cell.appendChild(bar);
        }
      });

      cell.addEventListener('click', () => showDayPanel(dateStr));
      cell.addEventListener('dblclick', () => openEventModal(null, dateStr));
      grid.appendChild(cell);
    }
    renderSidebar();
  }

  let _selectedDateStr = null;

  function showDayPanel(dateStr) {
    _selectedDateStr = dateStr;
    document.querySelectorAll('.day-cell').forEach(c => c.classList.remove('selected'));
    document.querySelector(`.day-cell[data-date="${dateStr}"]`)?.classList.add('selected');
    const d = parseDate(dateStr);
    document.getElementById('todayInfo').textContent =
      `${d.getFullYear()} / ${String(d.getMonth()+1).padStart(2,'0')} / ${String(d.getDate()).padStart(2,'0')}`;
    // Show quick-add button
    const addBtn = document.getElementById('quickAddForDay');
    if (addBtn) { addBtn.style.display = 'inline-block'; addBtn.dataset.date = dateStr; }
    const container = document.getElementById('todayEvents');
    container.innerHTML = '';
    const dayEvents = events.filter(e => e.date === dateStr);
    if (!dayEvents.length) { container.innerHTML='<div class="empty-state">// 暂无日程 //</div>'; }
    else dayEvents.forEach(ev => container.appendChild(createEventItem(ev)));
  }

  function createEventItem(ev) {
    const el = document.createElement('div');
    el.className='event-item'; el.style.borderColor=ev.color;
    el.dataset.evid = String(ev.id);
    const loc = ev.location ? `<span style="font-size:9px;opacity:0.6"> · 📍${ev.location}</span>` : '';
    el.innerHTML=`<div class="event-item-info" style="cursor:pointer"><div class="event-item-name" style="color:${ev.color}">${ev.name}${loc}</div><div class="event-item-meta">${ev.date}${ev.time?' · '+ev.time:''}</div></div><button class="event-item-del" data-id="${ev.id}" title="Delete">✕</button>`;
    el.querySelector('.event-item-info').addEventListener('click', () => {
      // Always look up fresh from events array by id
      const fresh = events.find(e => String(e.id) === String(ev.id));
      //dbg('[EDIT] id:', ev.id, 'fresh:', fresh);
      if (fresh) openEventModal(fresh);
    });
    el.querySelector('.event-item-del').addEventListener('click', e => { e.stopPropagation(); delEvent(ev.id); });
    return el;
  }

  function renderSidebar() {
    const allEl = document.getElementById('allEventsList');
    allEl.innerHTML='';
    if (!events.length) { allEl.innerHTML='<div class="empty-state">// 暂无日程 //</div>'; }
    else { [...events].sort((a,b)=>a.date.localeCompare(b.date)).forEach(ev=>allEl.appendChild(createEventItem(ev))); }

    const taskEl = document.getElementById('allTasksList');
    taskEl.innerHTML='';
    if (!tasks.length) { taskEl.innerHTML='<div class="empty-state">// 暂无任务 //</div>'; }
    else {
      tasks.forEach(task => {
        const el=document.createElement('div'); el.className='task-item'; el.style.borderColor=task.color;
        const start=parseDate(task.start), end=parseDate(task.end), now=new Date();
        const total=end-start, elapsed=Math.min(now-start,total);
        const progress=total>0?Math.max(0,Math.min(100,(elapsed/total)*100)):100;
        el.innerHTML=`<button class="task-item-del" data-id="${task.id}">✕</button><div class="task-item-name" style="color:${task.color}">${task.name}</div><div class="task-item-dates">${task.start} → DDL ${task.end}</div><div class="task-progress"><div class="task-progress-fill" style="width:${progress}%;background:${task.color}"></div></div>`;
        el.querySelector('.task-item-del').addEventListener('click', e => { e.stopPropagation(); tasks=tasks.filter(x=>x.id!==task.id); save(); renderCalendar(); });
        taskEl.appendChild(el);
      });
    }

    const todayStr=toDateStr(currentDate.getFullYear(),currentDate.getMonth(),currentDate.getDate());
    document.getElementById('todayInfo').textContent=`${currentDate.getFullYear()} / ${String(currentDate.getMonth()+1).padStart(2,'0')} / ${String(currentDate.getDate()).padStart(2,'0')}`;
    const todayEl=document.getElementById('todayEvents'); todayEl.innerHTML='';
    const dayEvents=events.filter(e=>e.date===todayStr);
    if(!dayEvents.length){todayEl.innerHTML='<div class="empty-state">// 暂无日程 //</div>';}
    else dayEvents.forEach(ev=>todayEl.appendChild(createEventItem(ev)));
  }

  // ════════════════════════════════════
  // COLOR PICKERS
  // ════════════════════════════════════
  function setupColorPicker(id) {
    document.getElementById(id).querySelectorAll('.color-opt').forEach(opt => {
      opt.addEventListener('click', () => {
        document.getElementById(id).querySelectorAll('.color-opt').forEach(o=>o.classList.remove('selected'));
        opt.classList.add('selected');
      });
    });
  }
  setupColorPicker('eventColorPicker');
  setupColorPicker('taskColorPicker');

  // ════════════════════════════════════
  // SCROLL PICKER
  // ════════════════════════════════════
  // ── SCROLL PICKER: snap-based, AbortController for clean listener removal ──
  const ITEM_H = 36;
  const _scrollAbort = {};  // keyed by col id

  function buildScrollCol(elOrId, items, selectedVal) {
    const id = typeof elOrId === 'string' ? elOrId : elOrId.id;
    const el = document.getElementById(id);

    // Cancel previous scroll listener cleanly
    if (_scrollAbort[id]) { _scrollAbort[id].abort(); }
    _scrollAbort[id] = new AbortController();
    const signal = _scrollAbort[id].signal;

    // Rebuild DOM
    const frag = document.createDocumentFragment();
    const spacer = () => { const d = document.createElement('div'); d.className='scroll-item'; d.style.visibility='hidden'; return d; };
    frag.appendChild(spacer());
    items.forEach((item, idx) => {
      const d = document.createElement('div');
      d.className = 'scroll-item';
      d.textContent = item.label;
      d.dataset.val = String(item.val);
      d.dataset.idx = idx;
      frag.appendChild(d);
    });
    frag.appendChild(spacer());
    el.innerHTML = '';
    el.appendChild(frag);

    // Scroll to selected (after DOM paint)
    const selIdx = items.findIndex(i => String(i.val) === String(selectedVal));
    const targetIdx = selIdx >= 0 ? selIdx : 0;
    requestAnimationFrame(() => {
      el.scrollTop = targetIdx * ITEM_H;
    });

    // Debounced scroll: snap + update active
    let scrollTimer = null;
    el.addEventListener('scroll', () => {
      if (scrollTimer) clearTimeout(scrollTimer);
      scrollTimer = setTimeout(() => {
        scrollTimer = null;
        const idx = Math.round(el.scrollTop / ITEM_H);
        el.querySelectorAll('.scroll-item[data-val]').forEach((it, i) => it.classList.toggle('active', i === idx));
        el.scrollTop = idx * ITEM_H;
        if (id === 'monthCol' || id === 'yearCol') updateDayCount();
      }, 80);
    }, { passive: true, signal });

    // Click to jump
    el.querySelectorAll('.scroll-item[data-val]').forEach((item, idx) => {
      item.addEventListener('click', () => { el.scrollTop = idx * ITEM_H; }, { signal });
    });
  }

  function getScrollVal(colId) {
    const el = document.getElementById(colId);
    if (!el) return null;
    const idx = Math.round(el.scrollTop / ITEM_H);
    const items = el.querySelectorAll('.scroll-item[data-val]');
    return items[idx]?.dataset.val ?? null;
  }

  function updateDayCount() {
    const y = parseInt(getScrollVal('yearCol'))  || new Date().getFullYear();
    const m = parseInt(getScrollVal('monthCol')) || new Date().getMonth() + 1;
    const prevDay = parseInt(getScrollVal('dayCol')) || 1;
    const daysInMonth = new Date(y, m, 0).getDate();
    const dayEl = document.getElementById('dayCol');
    const dayItems = dayEl.querySelectorAll('.scroll-item[data-val]');
    // Just hide/show items beyond daysInMonth — no DOM rebuild
    dayItems.forEach(it => {
      const v = parseInt(it.dataset.val);
      it.style.display = v <= daysInMonth ? '' : 'none';
    });
    // Clamp selection if needed
    const cur = parseInt(getScrollVal('dayCol')) || 1;
    if (cur > daysInMonth) dayEl.scrollTop = (daysInMonth - 1) * ITEM_H;
  }

  function initDatePicker(dateStr) {
    const now = dateStr ? new Date(dateStr + 'T00:00:00') : new Date();
    const selYear = now.getFullYear(), selMonth = now.getMonth()+1, selDay = now.getDate();

    const years  = Array.from({length:16}, (_,i) => ({val:2020+i, label:String(2020+i)}));
    const months = Array.from({length:12}, (_,i) => ({val:i+1, label:String(i+1).padStart(2,'0')}));
    const days   = Array.from({length:31}, (_,i) => ({val:i+1, label:String(i+1).padStart(2,'0')}));

    buildScrollCol('yearCol',  years,  selYear);
    buildScrollCol('monthCol', months, selMonth);
    buildScrollCol('dayCol',   days,   selDay);
    updateDayCount();
  }

  function initTimePicker(timeStr) {
    const now = new Date();
    const parts = (timeStr || '').split(':');
    // If editing existing event, use its time; otherwise default to current hour, rounded minute
    const selH = parts[0] !== undefined && timeStr ? parseInt(parts[0]) : now.getHours();
    const rawM = parts[1] !== undefined && timeStr ? parseInt(parts[1]) : now.getMinutes();
    const selM = Math.round(rawM / 5) * 5 % 60;
    const hours   = Array.from({length:24}, (_,i) => ({val:i,   label:String(i).padStart(2,'0')}));
    const minutes = Array.from({length:12}, (_,i) => ({val:i*5, label:String(i*5).padStart(2,'0')}));
    buildScrollCol('hourCol',   hours,   selH);
    buildScrollCol('minuteCol', minutes, selM);
  }

  function getPickedDate() {
    const y = getScrollVal('yearCol'), m = getScrollVal('monthCol'), d = getScrollVal('dayCol');
    if (!y || !m || !d) return '';
    return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
  }

  function getPickedTime() {
    const h = getScrollVal('hourCol'), m = getScrollVal('minuteCol');
    if (h === null || m === null) return '';
    return `${String(parseInt(h)).padStart(2,'0')}:${String(parseInt(m)).padStart(2,'0')}`;
  }

  // ════════════════════════════════════
  // MODAL OPEN / RESET / EDIT
  // ════════════════════════════════════
  function openEventModal(ev, presetDate) {
    const isEdit = !!ev;
    document.getElementById('eventModalTitle').textContent = isEdit ? '// EDIT EVENT //' : '// ADD EVENT //';
    const idToSet = isEdit ? String(ev.id) : '';
    document.getElementById('editingEventId').value = idToSet;
    //dbg('[MODAL] isEdit:', isEdit, 'setting editingEventId to:', idToSet);
    document.getElementById('eventName').value = isEdit ? ev.name : '';
    document.getElementById('eventLocation').value = isEdit ? (ev.location || '') : '';
    document.getElementById('deleteEditingEvent').style.display = isEdit ? 'inline-block' : 'none';

    // reset color picker
    document.getElementById('eventColorPicker').querySelectorAll('.color-opt').forEach((o,i) => {
      o.classList.toggle('selected', isEdit ? o.dataset.color === ev.color : i === 0);
    });

    // date: editing → use event date; new with preset → use preset; new → today
    const dateForPicker = isEdit ? ev.date : (presetDate || _selectedDateStr || toDateStr(currentYear, currentMonth, new Date().getDate()));
    initDatePicker(dateForPicker);
    // time: editing → use event time (may be empty string); new → current time
    initTimePicker(isEdit ? (ev.time || '') : '');

    document.getElementById('eventModalOverlay').classList.add('active');
  }

  document.getElementById('openEventModal').addEventListener('click', () => openEventModal(null));
  document.getElementById('closeEventModal').addEventListener('click', () => document.getElementById('eventModalOverlay').classList.remove('active'));
  document.getElementById('openTaskModal').addEventListener('click', () => {
    document.getElementById('taskName').value = '';
    document.getElementById('taskModalOverlay').classList.add('active');
  });
  document.getElementById('closeTaskModal').addEventListener('click', () => document.getElementById('taskModalOverlay').classList.remove('active'));

  document.getElementById('prevMonth').addEventListener('click', () => { currentMonth--; if(currentMonth<0){currentMonth=11;currentYear--;} renderCalendar(); });
  document.getElementById('nextMonth').addEventListener('click', () => { currentMonth++; if(currentMonth>11){currentMonth=0;currentYear++;} renderCalendar(); });

  // ════════════════════════════════════
  // SAVE / UPDATE EVENT (Supabase)
  // ════════════════════════════════════
  document.getElementById('saveEvent').addEventListener('click', async () => {
    const name = document.getElementById('eventName').value.trim();
    const location = document.getElementById('eventLocation').value.trim();
    const date = getPickedDate();
    const time = getPickedTime();
    const colorEl = document.querySelector('#eventColorPicker .selected');
    const color = colorEl ? colorEl.dataset.color : '#a78bfa';
    const editId = document.getElementById('editingEventId').value;
    //dbg('[SAVE] editId:', JSON.stringify(editId), '| name:', name, '| date:', date);
    if (!name || !date) return;

    const btn = document.getElementById('saveEvent');
    btn.textContent = '...'; btn.disabled = true;

    if (editId) {
      // ── DEBUG: log exactly what we're sending ──
      //dbg('[UPDATE] editId:', editId, 'user.id:', user?.id);
      //dbg('[UPDATE] payload:', { name, date, time, color, location });

      const { data, error, status, statusText } = await supabaseClient
        .from('events')
        .update({ name, date, time, color, location })
        .eq('id', editId)
        .select();

      //dbg('[UPDATE] status:', status, statusText);
      //dbg('[UPDATE] data:', data);
      //dbg('[UPDATE] error:', error);

      if (error) {
        alert('❌ Update failed\n' + error.message + '\n\nCheck console for details.');
      } else if (data && data.length > 0) {
        // Success — update local array
        events = events.map(e => String(e.id) === String(editId) ? data[0] : e);
        document.getElementById('eventModalOverlay').classList.remove('active');
        renderCalendar();
      } else {
        // Empty result — likely RLS is blocking (no error but no rows updated)
        dbg('[UPDATE] Empty result — possible RLS policy blocking update');
        alert('⚠️ 修改未生效\n\n可能原因：Supabase RLS 策略未允许 UPDATE。\n请在 Supabase Dashboard → Authentication → Policies 里检查 events 表是否有 UPDATE 策略。');
        // Still refetch so UI is in sync
        await fetchAllData();
        document.getElementById('eventModalOverlay').classList.remove('active');
      }
    } else {
      // INSERT
      const { data, error } = await supabaseClient
        .from('events')
        .insert([{ name, date, time, color, location, user_id: user.id }])
        .select();

      if (error) {
        alert('❌ Insert failed\n' + error.message);
      } else if (data && data.length > 0) {
        events.push(data[0]);
        document.getElementById('eventModalOverlay').classList.remove('active');
        renderCalendar();
      }
    }

    btn.textContent = 'CONFIRM'; btn.disabled = false;
  });

  // Delete from edit modal
  document.getElementById('deleteEditingEvent').addEventListener('click', async () => {
    const id = document.getElementById('editingEventId').value;
    if (!id) return;
    await supabaseClient.from('events').delete().eq('id', id);
    events = events.filter(e => e.id != id);
    document.getElementById('eventModalOverlay').classList.remove('active');
    renderCalendar();
  });

  // ════════════════════════════════════
  // SAVE TASK (Supabase)
  // ════════════════════════════════════
  document.getElementById('saveTask').addEventListener('click', async () => {
    const name = document.getElementById('taskName').value.trim();
    const start = document.getElementById('taskStart').value;
    const end = document.getElementById('taskEnd').value || start;
    const colorEl = document.querySelector('#taskColorPicker .selected');
    const color = colorEl ? colorEl.dataset.color : '#f472b6';
    if (!name || !start) return;
    const { data, error } = await supabaseClient.from('tasks')
      .insert([{ name, start, end, color, user_id: user.id }]).select();
    if (data) {
      tasks.push(data[0]);
      document.getElementById('taskModalOverlay').classList.remove('active');
      renderCalendar();
    }
    if (error) console.error(error);
  });

  // ── DELETE (Supabase) ──
  function delEvent(id) {
    supabaseClient.from('events').delete().eq('id', id).then(() => {
      events = events.filter(e => e.id != id); renderCalendar();
    });
  }
  function delTask(id) {
    if (!confirm('Remove this task?')) return;
    supabaseClient.from('tasks').delete().eq('id', id).then(() => {
      tasks = tasks.filter(t => t.id != id); renderCalendar();
    });
  }

  // ── FETCH ALL DATA ──
  async function fetchAllData() {
    if (!user) return;
    const { data: eData } = await supabaseClient.from('events').select('*').eq('user_id', user.id);
    if (eData) events = eData;
    const { data: tData } = await supabaseClient.from('tasks').select('*').eq('user_id', user.id);
    if (tData) tasks = tData;
    renderCalendar();
  }

  // ── SUPABASE AUTH ──
  const SUPABASE_URL = 'https://pqbtavdigefbntegalga.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxYnRhdmRpZ2VmYm50ZWdhbGdhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNjAwNTQsImV4cCI6MjA4NjkzNjA1NH0.vCL9xK7icZPFrnellbZYul9GanRcRE_v8pe-RXJn2iI';
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  let user = null;
  let isLoginMode = true;

  supabaseClient.auth.onAuthStateChange((event, session) => {
    if (session) {
      user = session.user;
      document.getElementById('auth-overlay').classList.add('hidden');
      document.getElementById('mainApp').classList.add('visible');
      document.getElementById('logoutBtn').style.display = 'block';
      document.getElementById('userEmailDisplay').textContent = ':: ' + user.email;
      fetchAllData();
    } else {
      user = null;
      document.getElementById('auth-overlay').classList.remove('hidden');
      document.getElementById('mainApp').classList.remove('visible');
      document.getElementById('logoutBtn').style.display = 'none';
    }
  });

  document.getElementById('loginActionBtn').addEventListener('click', async () => {
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    const msg = document.getElementById('authMsg');
    if (!email || !password) { msg.textContent = 'Please fill in email & password.'; return; }
    msg.textContent = 'Connecting to the archive...';
    if (isLoginMode) {
      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) msg.textContent = error.message;
    } else {
      const { error } = await supabaseClient.auth.signUp({ email, password });
      if (error) msg.textContent = error.message;
      else { msg.textContent = 'Registered! Check email or login directly.'; isLoginMode = true; updateAuthUI(); }
    }
  });

  document.getElementById('switchModeBtn').addEventListener('click', () => { isLoginMode = !isLoginMode; updateAuthUI(); });
  function updateAuthUI() {
    document.getElementById('loginActionBtn').textContent = isLoginMode ? 'ENTER THE ARCHIVE' : 'REGISTER IDENTITY';
    document.getElementById('switchModeBtn').textContent = isLoginMode ? 'No account? Click to Register' : 'Have an account? Login';
    document.getElementById('authMsg').textContent = '';
  }
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await supabaseClient.auth.signOut();
    events = []; tasks = []; renderCalendar();
  });

  // ── DAILY ALCHEMY QUOTE ──
  async function fetchDailyQuote() {
    const today = new Date().toDateString();
    const cacheKey = 'amethy_quote_' + today;

    try {
      const cached = localStorage.getItem(cacheKey);
      if (cached) { setQuote(cached); return; }
    } catch(e) {}

    setQuote('<span style="color:var(--text-dim);font-size:10px;letter-spacing:1px">✦   consulting the stars   ✦</span>');

    try {
      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 120,
          messages: [{
            role: 'user',
            content: `You are the spirit of an ancient alchemist calendar. Generate a single evocative alchemist's daily inscription for ${today}. It should be mysterious, poetic, 1-2 sentences, referencing celestial bodies, elements, transformation, or esoteric wisdom. Use archaic but beautiful language. No quotation marks, no preamble — just the inscription itself.`
          }]
        })
      });
      const data = await res.json();
      const text = data.content?.[0]?.text?.trim() || '✶ The stars keep their counsel today. ✶';
      try { localStorage.setItem(cacheKey, text); } catch(e) {}
      setQuote(text);
    } catch(e) {
      setQuote('✶ When the Moon conjuncts Saturn, patience becomes the philosopher’s stone. ✶');
    }
  }

  function setQuote(text) {
    const el = document.getElementById('alchemyContent');
    if (el) el.innerHTML = `<span style="font-family:'Cinzel',serif;font-size:10.5px;line-height:1.8;color:#d4c8f0;letter-spacing:0.8px;font-style:italic;text-align:center;display:block;">${text}</span>`;
  }

  fetchDailyQuote();
</script>

<!-- DEBUG PANEL -->
<div id="debugPanel" style="position:fixed;bottom:0;left:0;right:0;z-index:99999;background:rgba(0,0,0,0.92);border-top:1px solid #a78bfa;padding:8px 16px;font-family:monospace;font-size:11px;color:#7ee8c8;max-height:120px;overflow-y:auto;display:none;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
    <span style="color:#fbbf24;letter-spacing:2px;font-size:10px">DEBUG LOG</span>
    <button onclick="document.getElementById('debugPanel').style.display='none'" style="background:none;border:none;color:#666;cursor:pointer;font-size:14px">✕</button>
  </div>
  <div id="debugLog"></div>
</div>


<div id="debugPanel" style="position:fixed;bottom:0;left:0;right:0;z-index:99999;background:rgba(0,0,0,0.93);border-top:2px solid #a78bfa;padding:8px 16px;font-family:monospace;font-size:11px;color:#7ee8c8;max-height:130px;overflow-y:auto;display:none;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
    <span style="color:#fbbf24;letter-spacing:2px;font-size:10px">✦ DEBUG LOG</span>
    <button onclick="document.getElementById('debugPanel').style.display='none';document.getElementById('debugLog').innerHTML=''" style="background:none;border:none;color:#888;cursor:pointer;font-size:13px">✕ close</button>
  </div>
  <div id="debugLog"></div>
</div>
</body>
</html>